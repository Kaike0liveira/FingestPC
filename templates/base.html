<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fingest</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="manifest" href="/static/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="brand">Fingest</div>
        <div class="nav">
          <a href="/">Home</a>
          <a href="/dashboard">Dashboard</a>
          <a href="/add_expense">Adicionar</a>
          <a href="/export">Exportar</a>
        </div>
      </div>
      <div class="nav-right">
        {% if session.username %}
        <div class="avatar-dropdown">
          <img class="avatar" src="{% if user and user.photo %}/static/uploads/{{ user.photo }}{% else %}/static/default-avatar.svg{% endif %}" alt="avatar">
          <div class="dropdown">
            <a href="/profile">Perfil</a>
            <a href="/settings">Configurações</a>
            {% if session.role == 'admin' %}
            <a href="/admin">Admin</a>
            {% endif %}
            <a href="/logout" class="btn-logout">Sair</a>
          </div>
        </div>
        {% else %}
        <a class="btn" href="/login">Login</a>
        {% endif %}
        <button id="theme-toggle" class="btn small">Tema</button>
      </div>
    </nav>

    <div class="loading-overlay" id="loadingOverlay" aria-hidden="true">
      <div class="loader" role="status" aria-label="Carregando"></div>
    </div>

    <!-- Modal de confirmação global -->
    <div id="confirmModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="confirmTitle" style="display:none">
      <div class="modal-backdrop"></div>
      <div class="modal-card" role="document">
        <h3 id="confirmTitle">Confirmação</h3>
        <p id="confirmText">Tem certeza?</p>
        <form id="confirmForm" method="post">
          <input type="hidden" name="csrf_token" id="confirmCsrf">
          <input type="hidden" name="user_id" id="confirmUserId">
          <input type="hidden" name="role" id="confirmRole">
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
            <button type="button" class="btn ghost" id="confirmCancel">Cancelar</button>
            <button type="submit" class="btn primary" id="confirmOk">Confirmar</button>
          </div>
        </form>
      </div>
    </div>

    <main class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash">
            {% for category, msg in messages %}
              <div class="alert {{ category }}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <script>
      const toggle = document.getElementById('theme-toggle');
      const current = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', current);
      toggle && toggle.addEventListener('click', () => {
        const t = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
      });
      // loading overlay behavior
      const overlay = document.getElementById('loadingOverlay');
      function showLoading() { overlay.classList.add('show'); }
      function hideLoading() { overlay.classList.remove('show'); }

      // show loader on any form submit or link click (progressive)
      document.addEventListener('submit', (e) => { showLoading(); });
      document.addEventListener('click', (e) => {
        const a = e.target.closest && e.target.closest('a');
        if (a && a.getAttribute('href') && a.getAttribute('href').startsWith('/') ) {
          showLoading();
        }
      });
      // hide after page load (in case SPA not used)
      window.addEventListener('load', hideLoading);

      // Modal confirmation logic for delete actions
      const confirmModal = document.getElementById('confirmModal');
      const confirmForm = document.getElementById('confirmForm');
      const confirmText = document.getElementById('confirmText');
      const confirmCsrf = document.getElementById('confirmCsrf');
      const confirmCancel = document.getElementById('confirmCancel');

      function openConfirm({text, action, csrf, method='post', user_id, role}){
        confirmText.textContent = text || 'Tem certeza?';
        confirmForm.action = action || '';
        confirmForm.method = method || 'post';
        if(csrf) confirmCsrf.value = csrf;
        if(user_id !== undefined) document.getElementById('confirmUserId').value = user_id;
        if(role !== undefined) document.getElementById('confirmRole').value = role;
        // accessibility: save previous focus
        confirmModal._previousActive = document.activeElement;
        confirmModal.style.display = 'block';
        confirmModal.setAttribute('aria-hidden', 'false');
        // focus first actionable element
        document.getElementById('confirmCancel').focus();
      }

      function closeConfirm(){
        confirmModal.style.display = 'none';
        confirmModal.setAttribute('aria-hidden', 'true');
      }

      confirmCancel && confirmCancel.addEventListener('click', (e)=>{ e.preventDefault(); closeConfirm(); });

      // close with Escape
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && confirmModal.getAttribute('aria-hidden') === 'false'){
          closeConfirm();
        }
      });

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest && e.target.closest('.btn-delete-expense');
        if(btn){
          e.preventDefault();
          const url = btn.getAttribute('data-delete-url');
          const csrf = btn.getAttribute('data-csrf');
          openConfirm({ text: 'Tem certeza que deseja remover esta despesa?', action: url, csrf: csrf, method: 'post' });
          return;
        }

        const adminBtn = e.target.closest && e.target.closest('.btn-admin-setrole');
        if(adminBtn){
          e.preventDefault();
          const userId = adminBtn.getAttribute('data-user-id');
          const csrf = adminBtn.getAttribute('data-csrf');
          const selectId = adminBtn.getAttribute('data-select-id');
          const select = document.getElementById(selectId);
          const role = select ? select.value : 'user';
          openConfirm({ text: `Confirma alteração de papel para ${role} ?`, action: '/admin/set_role', csrf: csrf, method: 'post', user_id: userId, role: role });
          return;
        }

        const logout = e.target.closest && e.target.closest('.btn-logout');
        if(logout){
          e.preventDefault();
          const url = logout.getAttribute('href');
          openConfirm({ text: 'Deseja sair da sessão?', action: url, method: 'get' });
          return;
        }
      });

      // close modal on backdrop click
      document.addEventListener('click', (e)=>{
        if(e.target.classList && e.target.classList.contains('modal-backdrop')) closeConfirm();
      });

      // register service worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/static/sw.js').catch(function(err){ console.log('SW reg failed', err); });
        });
      }
    </script>
  </body>
</html>
